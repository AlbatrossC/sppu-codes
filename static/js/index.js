console.log(`
    â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â£¿â£¿â£¿â¡†â €â €â €â¢€â£´â£¶â£¶â£¶â£¶â£„â €â£€â£´â£¶â£¶â£¶â£¶â¡€â €â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â¢ â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¦â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â¢ˆâ£¿â£¿â €â €â €â €â €â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡¿â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â ¸â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡¿â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â ¹â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â Ÿâ â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â €â ˆâ »â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡¿â ‹â €â €â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â¢€â£€â£¸â£¿â£¿â£€â£€â¡€â €â €â €â €â €â €â ˆâ »â¢¿â¢¿â£¿â£¿â£¿â Ÿâ â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â ¸â ¿â ¿â ¿â ¿â ¿â ¿â ‡â €â €â €â €â €â €â €â €â €â ˆâ ™â ‰â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â¢¾â£¿â£¿â£¿â£¿â£¿â£¿â †â  â£¿â¡¿â£¿â£¿â£¿â¢¿â£¿â£¦â£´â£¿â¡¿â ¿â¢¿â£¿â£·â£„â €â¢¾â£¿â£¿â£¿â£¿â¡¿â£¿â †â¢¸â£¿â£¿â£¿â£¿â£¿â¡†â €â €â €â €
    â €â €â €â €â €â €â ˆâ¢¿â£¿â£§â €â €â €â €â£ â£¿â¡¿â â €â£°â£¿â¡¿â â €â €â €â ˆâ »â£¿â£§â¡€â €â ˜â£¿â¡Ÿâ €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â¢»â£¿â£§â¡€â €â¢°â£¿â¡¿â â €â €â£¿â£¿â â €â €â €â €â €â €â¢»â£¿â£‡â €â €â£¿â¡‡â €â €â €â €â €â ¸â£¿â£¿â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â ¹â£¿â£·â£´â£¿â¡Ÿâ €â €â €â¢°â£¿â¡Ÿâ €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â£¿â¡‡â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â ™â£¿â£¿â¡â €â €â €â €â ˜â£¿â£§â €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â£¿â¡‡â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â£¿â£¿â¡€â €â €â €â €â €â£¿â£¿â¡„â €â €â €â €â €â €â£¿â£¿â ‡â €â €â£¿â£§â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â¢€â£€â£€â£¿â£¿â£‡â£€â¡€ â €â ˜â¢¿â£¿â£¦â£€â €â¢€â£ â£¾â£¿â â €â € â¢¿â£¿â£¦â¡€â €â €â£€â£¼â£¿â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â »â ¿â ¿â ¿â ¿â ¿â ¿â ¿â €â €â €â €â ™â ¿â¢¿â£¿â£¿â ¿â ›â â €â €â €â €â €â ™â ¿â¢¿â£¿â£¿â¡¿â Ÿâ €â €â €â €â €
    
    
            Hey, you! ðŸ‘€ Guess what?
                Sppu Codes is open-source
                    and totally free to explore! ðŸŽ‰
                        Dive in: https://github.com/AlbatrossC/sppu-codes
            â €
    `);
(function () {
    /* =====================================================
       GOOGLE TAG (UNCHANGED)
    ===================================================== */
    function loadGTM() {
        const script = document.createElement('script');
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-1R5FFVKTF8';
        script.async = true;
        script.onload = function () {
            window.dataLayer = window.dataLayer || [];
            function gtag() { window.dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-1R5FFVKTF8');
        };
        document.head.appendChild(script);
    }

    if (document.readyState === 'complete') {
        loadGTM();
    } else {
        window.addEventListener('load', loadGTM);
    }
})();

document.addEventListener('DOMContentLoaded', function () {
    /* =====================================================
       ELEMENTS
    ===================================================== */
    const searchInput = document.getElementById('subject-search');
    const mobileSearchToggle = document.querySelector('.mobile-search-toggle');
    const searchContainer = document.querySelector('.search-container');
    const header = document.querySelector('header');

    const searchDropdown = document.createElement('div');
    searchDropdown.className = 'search-dropdown';
    document.body.appendChild(searchDropdown);

    /* =====================================================
       STATE
    ===================================================== */
    let isLoaded = false;
    const MAX_RESULTS = 10;

    const searchData = {
        questionPapers: [],
        codes: []
    };

    /* =====================================================
       UTILS â€“ STRING NORMALIZATION
    ===================================================== */
    function normalize(str) {
        return str
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, '')
            .replace(/\s+/g, ' ')
            .trim();
    }

    /* =====================================================
       FUZZY SCORE (IMPROVED)
       Lower score = better match
    ===================================================== */
    function fuzzyScore(query, target) {
        if (!query || !target) return Infinity;

        query = normalize(query);
        target = normalize(target);

        if (target.startsWith(query)) return 0;              // best
        if (target.includes(query)) return 1;                // very good

        // Token similarity
        const qTokens = query.split(' ');
        const tTokens = target.split(' ');
        let hits = 0;

        qTokens.forEach(qt => {
            if (tTokens.some(tt => tt.startsWith(qt))) hits++;
        });

        if (hits > 0) return 2 - hits * 0.1;

        // Levenshtein fallback
        return levenshtein(query, target);
    }

    function levenshtein(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;

        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b[i - 1] === a[j - 1]) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j] + 1
                    );
                }
            }
        }
        return matrix[b.length][a.length];
    }

    /* =====================================================
       LOAD SEARCH DATA (ON DEMAND)
    ===================================================== */
    async function loadSearchData() {
        if (isLoaded) return;

        try {
            // Question Papers
            const qpRes = await fetch('/api/question-papers/search');
            const qpData = await qpRes.json();

            searchData.questionPapers = qpData.map(item => ({
                type: 'QUESTION_PAPER',
                label: 'ðŸ“„ Question Paper',
                subjectName: item.subject_name,
                subjectLink: item.subject_link,
                branchName: item.branch_name,
                // branchName is only for display, not for search
            }));

            // Codes (Subjects)
            const codeRes = await fetch('/api/subjects/search');
            const codeData = await codeRes.json();

            searchData.codes = codeData.map(s => ({
                type: 'CODE',
                label: 'ðŸ’» Code',
                subjectName: s.subject_name,
                subjectCode: s.subject_code,
                link: s.url
            }));

            isLoaded = true;
        } catch (err) {
            console.error('Search data load failed:', err);
        }
    }

    /* =====================================================
       SEARCH TOGGLE
    ===================================================== */
    if (mobileSearchToggle) {
        mobileSearchToggle.addEventListener('click', async (e) => {
            e.stopPropagation();
            searchContainer.classList.toggle('active');

            if (searchContainer.classList.contains('active')) {
                await loadSearchData();
                setTimeout(() => searchInput.focus(), 100);
            } else {
                searchDropdown.style.display = 'none';
            }
        });
    }

    /* =====================================================
       FILTER & SORT
    ===================================================== */
    function filterAndSort(query) {
        const resultsQP = [];
        const resultsCode = [];

        // Only search by subject name for question papers
        searchData.questionPapers.forEach(item => {
            const score = fuzzyScore(query, item.subjectName);
            if (score <= 3) resultsQP.push({ ...item, score });
        });

        // For codes, search by subject name and subject code (short form)
        searchData.codes.forEach(item => {
            const scoreName = fuzzyScore(query, item.subjectName);
            const scoreCode = fuzzyScore(query, item.subjectCode || "");
            const score = Math.min(scoreName, scoreCode);
            if (score <= 3) resultsCode.push({ ...item, score });
        });

        resultsQP.sort((a, b) => a.score - b.score);
        resultsCode.sort((a, b) => a.score - b.score);

        return { resultsQP, resultsCode };
    }

    // Remove highlightMatch, just return text as-is
    function highlightMatch(text, query) {
        return text;
    }

    /* =====================================================
       RENDER
    ===================================================== */
    function renderResults(qp, codes) {
        searchDropdown.innerHTML = '';

        function renderSection(title, items, typeClass) {
            if (!items.length) return;

            const section = document.createElement('div');
            section.className = 'search-section';

            const header = document.createElement('div');
            header.className = 'search-section-header';
            header.textContent = title;
            section.appendChild(header);

            const list = document.createElement('div');
            list.className = 'search-section-list';

            items.slice(0, MAX_RESULTS).forEach(item => {
                const row = document.createElement('div');
                row.className = `search-result-row ${typeClass}`;

                // For codes, show subject code as a badge
                let codeBadge = '';
                if (typeClass === 'code-row' && item.subjectCode) {
                    codeBadge = `<span class="result-shortcode">${highlightMatch(item.subjectCode, searchInput.value)}</span>`;
                }

                // For question papers, show branch name as a badge
                let branchBadge = '';
                if (typeClass === 'qp-row' && item.branchName) {
                    branchBadge = `<span class="result-branch">â€“ ${item.branchName}</span>`;
                }

                // Highlight subject name and code
                let highlightedName = highlightMatch(item.subjectName, searchInput.value);

                row.innerHTML = `
                    <span class="result-type-label">${item.label}</span>
                    <span class="result-main">
                        <span class="result-name">${highlightedName}${codeBadge}</span>
                        ${branchBadge}
                    </span>
                `;

                row.onclick = () => window.location.href = item.link || `/question-papers/${item.subjectLink}`;
                list.appendChild(row);
            });

            section.appendChild(list);
            searchDropdown.appendChild(section);
        }

        renderSection('Question Papers', qp, 'qp-row');
        renderSection('Codes', codes, 'code-row');

        if (!qp.length && !codes.length) {
            searchDropdown.innerHTML = `
                <div class="search-no-results">
                    No results found for "${searchInput.value}"
                </div>
            `;
        }
    }

    /* =====================================================
       POSITIONING
    ===================================================== */
    function positionDropdown() {
        const rect = searchInput.getBoundingClientRect();
        searchDropdown.style.position = 'absolute';
        searchDropdown.style.top = `${rect.bottom + window.scrollY}px`;
        searchDropdown.style.left = `${rect.left + window.scrollX}px`;
        searchDropdown.style.width = `${rect.width}px`;
    }

    /* =====================================================
       INPUT HANDLING
    ===================================================== */
    searchInput.addEventListener('input', async () => {
        const query = searchInput.value.trim();
        if (!query) {
            searchDropdown.style.display = 'none';
            return;
        }

        await loadSearchData();   // ðŸ”¥ ENSURE DATA EXISTS

        const { resultsQP, resultsCode } = filterAndSort(query);
        renderResults(resultsQP, resultsCode);
        positionDropdown();
        searchDropdown.style.display = 'block';
    });

    document.addEventListener('click', (e) => {
        if (!searchDropdown.contains(e.target) && e.target !== searchInput) {
            searchDropdown.style.display = 'none';
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            searchDropdown.style.display = 'none';
        }
    });

    /* =====================================================
       HEADER SCROLL EFFECT (UNCHANGED)
    ===================================================== */
    window.addEventListener('scroll', () => {
        if (window.scrollY > 50) header.classList.add('scrolled');
        else header.classList.remove('scrolled');
    });
});
