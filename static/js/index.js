console.log(`
    â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â£¿â£¿â£¿â¡†â €â €â €â¢€â£´â£¶â£¶â£¶â£¶â£„â €â£€â£´â£¶â£¶â£¶â£¶â¡€â €â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â¢ â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¦â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â¢ˆâ£¿â£¿â €â €â €â €â €â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡¿â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â ¸â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡¿â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â ¹â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â Ÿâ â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â €â ˆâ »â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡¿â ‹â €â €â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â¢€â£€â£¸â£¿â£¿â£€â£€â¡€â €â €â €â €â €â €â ˆâ »â¢¿â¢¿â£¿â£¿â£¿â Ÿâ â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â ¸â ¿â ¿â ¿â ¿â ¿â ¿â ‡â €â €â €â €â €â €â €â €â €â ˆâ ™â ‰â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
    â €â €â €â €â¢¾â£¿â£¿â£¿â£¿â£¿â£¿â †â  â£¿â¡¿â£¿â£¿â£¿â¢¿â£¿â£¦â£´â£¿â¡¿â ¿â¢¿â£¿â£·â£„â €â¢¾â£¿â£¿â£¿â£¿â¡¿â£¿â †â¢¸â£¿â£¿â£¿â£¿â£¿â¡†â €â €â €â €
    â €â €â €â €â €â €â ˆâ¢¿â£¿â£§â €â €â €â €â£ â£¿â¡¿â â €â£°â£¿â¡¿â â €â €â €â ˆâ »â£¿â£§â¡€â €â ˜â£¿â¡Ÿâ €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â¢»â£¿â£§â¡€â €â¢°â£¿â¡¿â â €â €â£¿â£¿â â €â €â €â €â €â €â¢»â£¿â£‡â €â €â£¿â¡‡â €â €â €â €â €â ¸â£¿â£¿â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â ¹â£¿â£·â£´â£¿â¡Ÿâ €â €â €â¢°â£¿â¡Ÿâ €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â£¿â¡‡â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â ™â£¿â£¿â¡â €â €â €â €â ˜â£¿â£§â €â €â €â €â €â €â €â¢¸â£¿â£¿â €â €â£¿â¡‡â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â €â €â €â£¿â£¿â¡€â €â €â €â €â €â£¿â£¿â¡„â €â €â €â €â €â €â£¿â£¿â ‡â €â €â£¿â£§â €â €â €â €â €â¢¸â£¿â£¿â €â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â¢€â£€â£€â£¿â£¿â£‡â£€â¡€ â €â ˜â¢¿â£¿â£¦â£€â €â¢€â£ â£¾â£¿â â €â € â¢¿â£¿â£¦â¡€â €â €â£€â£¼â£¿â €â €â €â €â €â €
    â €â €â €â €â €â €â €â €â »â ¿â ¿â ¿â ¿â ¿â ¿â ¿â €â €â €â €â ™â ¿â¢¿â£¿â£¿â ¿â ›â â €â €â €â €â €â ™â ¿â¢¿â£¿â£¿â¡¿â Ÿâ €â €â €â €â €
    
    
            Hey, you! ðŸ‘€ Guess what?
                Sppu Codes is open-source
                    and totally free to explore! ðŸŽ‰
                        Dive in: https://github.com/AlbatrossC/sppu-codes
            â €
    `);

// Google Analytics
(function () {
    function loadGTM() {
        const script = document.createElement('script');
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-1R5FFVKTF8';
        script.async = true;
        script.onload = function () {
            window.dataLayer = window.dataLayer || [];
            function gtag() { window.dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-1R5FFVKTF8');
        };
        document.head.appendChild(script);
    }

    if (document.readyState === 'complete') {
        loadGTM();
    } else {
        window.addEventListener('load', loadGTM);
    }
})();

// Search Functionality
document.addEventListener('DOMContentLoaded', function () {
    /* =====================================================
       ELEMENTS
    ===================================================== */
    const searchInput = document.getElementById('subject-search');
    const mobileSearchToggle = document.querySelector('.mobile-search-toggle');
    const searchContainer = document.querySelector('.search-container');
    const header = document.querySelector('header');

    // Create or get search dropdown
    let searchDropdown = document.querySelector('.search-dropdown');
    if (!searchDropdown) {
        searchDropdown = document.createElement('div');
        searchDropdown.className = 'search-dropdown';
        document.body.appendChild(searchDropdown);
    }

    let isLoaded = false;
    const MAX_RESULTS = 10;

    const searchData = {
        questionPapers: [],
        codes: []
    };

    /* =====================================================
       HARDCODED SUBJECT DATA (FALLBACK)
    ===================================================== */
    const HARDCODED_SUBJECTS = [
        { subject_code: "oopl", subject_name: "Object-Oriented Programming Lab" },
        { subject_code: "cgl", subject_name: "Computer Graphics Lab" },
        { subject_code: "dsl", subject_name: "Data Structures Laboratory" },
        { subject_code: "iotl", subject_name: "Internet of Things Laboratory" },
        { subject_code: "dsal", subject_name: "Data Structures and Algorithms Laboratory" },
        { subject_code: "dbms", subject_name: "DataBase Management Systems" },
        { subject_code: "cnl", subject_name: "Computer Networks Laboratory" },
        { subject_code: "ai", subject_name: "Artificial Intelligence Laboratory" }
    ];

    /* =====================================================
       SEARCH UTILITIES
    ===================================================== */
    function normalize(str) {
        if (!str) return "";
        return str
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
    }

    function fuzzyScore(query, target, code = "") {
        if (!query || (!target && !code)) return Infinity;
        query = normalize(query);
        target = normalize(target);
        code = normalize(code);

        if (target.startsWith(query) || code.startsWith(query)) return 0;
        if (target.includes(query) || code.includes(query)) return 1;

        const qTokens = query.split(' ');
        const tTokens = target.split(' ');
        let hits = 0;
        qTokens.forEach(qt => {
            if (tTokens.some(tt => tt.startsWith(qt)) || code.startsWith(qt)) hits++;
        });
        if (hits > 0) return 2 - hits * 0.1;

        return Math.min(
            levenshtein(query, target),
            code ? levenshtein(query, code) : 99
        );
    }

    function levenshtein(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b[i - 1] === a[j - 1]) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j] + 1
                    );
                }
            }
        }
        return matrix[b.length][a.length];
    }

    function highlight(text, query) {
        if (!query) return text;
        const normQuery = normalize(query);
        if (!normQuery) return text;
        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'ig');
        return text.replace(regex, '<mark>$1</mark>');
    }

    /* =====================================================
       LOAD SEARCH DATA
    ===================================================== */
    async function loadSearchData() {
        if (isLoaded) return;
        try {
            // Load Question Papers
            const qpRes = await fetch('/api/question-papers/list');
            const qpData = await qpRes.json();
            searchData.questionPapers = qpData.map(item => ({
                type: 'QUESTION_PAPER',
                label: 'ðŸ“„ QP',
                subjectName: item.subject_name,
                subjectCode: '', // no code in list; keep empty
                link: item.public_url,
                branch: item.branch_name || item.branch_code || ''
            }));

            // Load Codes (Subjects)
            let codeData = [];
            try {
                const codeRes = await fetch('/api/subjects/search');
                codeData = await codeRes.json();
            } catch (e) {
                codeData = [];
            }

            if (!Array.isArray(codeData) || codeData.length === 0) {
                codeData = HARDCODED_SUBJECTS;
            }

            searchData.codes = codeData.map(s => ({
                type: 'CODE',
                label: 'ðŸ’» Code',
                subjectName: s.subject_name,
                subjectCode: s.subject_code || s.subject_link || '',
                link: s.url || `/${(s.subject_code || s.subject_link || '').replace(/^\//, '')}`
            }));

            isLoaded = true;
        } catch (err) {
            searchData.codes = HARDCODED_SUBJECTS.map(s => ({
                type: 'CODE',
                label: 'ðŸ’» Code',
                subjectName: s.subject_name,
                subjectCode: s.subject_code,
                link: `/${s.subject_code}`
            }));
            isLoaded = true;
            console.error('Search data load failed:', err);
        }
    }

    /* =====================================================
       MOBILE SEARCH TOGGLE
    ===================================================== */
    function updateSearchBarVisibility() {
        if (window.innerWidth >= 900) {
            searchContainer.classList.add('active');
            searchContainer.style.display = 'flex';
        } else {
            if (!searchContainer.classList.contains('active')) {
                searchContainer.style.display = '';
            }
        }
    }

    updateSearchBarVisibility();
    window.addEventListener('resize', updateSearchBarVisibility);

    if (mobileSearchToggle) {
        mobileSearchToggle.addEventListener('click', async (e) => {
            e.stopPropagation();
            searchContainer.classList.toggle('active');
            if (searchContainer.classList.contains('active')) {
                await loadSearchData();
                setTimeout(() => searchInput.focus(), 150);
            } else {
                searchDropdown.style.display = 'none';
            }
        });
    }

    /* =====================================================
       FILTER AND SORT RESULTS
    ===================================================== */
    function filterAndSort(query) {
        const resultsQP = [];
        const resultsCode = [];

        searchData.questionPapers.forEach(item => {
            const score = fuzzyScore(query, item.subjectName);
            if (score <= 3) resultsQP.push({ ...item, score });
        });

        searchData.codes.forEach(item => {
            const scoreName = fuzzyScore(query, item.subjectName, item.subjectCode);
            const scoreCode = fuzzyScore(query, item.subjectCode || "");
            const score = Math.min(scoreName, scoreCode);
            if (score <= 3) resultsCode.push({ ...item, score });
        });

        resultsQP.sort((a, b) => a.score - b.score);
        resultsCode.sort((a, b) => a.score - b.score);
        return { resultsQP, resultsCode };
    }

    /* =====================================================
       RENDER SEARCH RESULTS
    ===================================================== */
    function renderResults(qp, codes) {
        searchDropdown.innerHTML = '';

        function renderSection(title, items, typeClass) {
            if (!items.length) return;

            const section = document.createElement('div');
            section.className = 'search-section';
            
            const header = document.createElement('div');
            header.className = 'search-section-header';
            header.textContent = title;
            section.appendChild(header);

            const list = document.createElement('div');
            list.className = 'search-section-list';

            items.slice(0, MAX_RESULTS).forEach(item => {
                const row = document.createElement('div');
                row.className = `search-result-row ${typeClass}`;

                let badge = '';
                if (typeClass === 'code-row' && item.subjectCode) {
                    badge = `<span class="result-shortcode">${item.subjectCode.toUpperCase()}</span>`;
                } else if (typeClass === 'qp-row' && item.branch) {
                    badge = `<span class="result-branch">${item.branch}</span>`;
                }

                const iconSvg = typeClass === 'qp-row' 
                    ? '<svg style="width:1em;height:1em;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/></svg>'
                    : '<svg style="width:1em;height:1em;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>';

                row.innerHTML = `
                    <span class="result-name">${highlight(item.subjectName, searchInput.value)}</span>
                    ${badge}
                    <span class="result-type-label">
                        ${iconSvg}
                        ${typeClass === 'qp-row' ? 'QP' : 'CODE'}
                    </span>
                `;

                row.onclick = () => {
                    if (item.link) {
                        window.location.href = item.link;
                    }
                };
                
                list.appendChild(row);
            });

            section.appendChild(list);
            searchDropdown.appendChild(section);
        }

        renderSection('Question Papers', qp, 'qp-row');
        renderSection('Codes', codes, 'code-row');

        if (!qp.length && !codes.length) {
            searchDropdown.innerHTML = `<div class="search-no-results">No results found for "${searchInput.value}"</div>`;
        }
    }

    /* =====================================================
       POSITION DROPDOWN
    ===================================================== */
    function positionDropdown() {
        const rect = searchInput.getBoundingClientRect();
        if (window.innerWidth <= 899) {
            searchDropdown.style.position = 'fixed';
            const topOffset = header.offsetHeight + (searchContainer.classList.contains('active') ? searchContainer.offsetHeight : 0);
            searchDropdown.style.top = `${topOffset}px`;
            searchDropdown.style.left = '0';
            searchDropdown.style.width = '100vw';
            searchDropdown.style.maxWidth = '100vw';
        } else {
            searchDropdown.style.position = 'absolute';
            searchDropdown.style.top = `${rect.bottom + window.scrollY + 4}px`;
            searchDropdown.style.left = `${rect.left + window.scrollX}px`;
            searchDropdown.style.width = `${rect.width}px`;
            searchDropdown.style.maxWidth = `${rect.width}px`;
        }
        searchDropdown.style.display = 'block';
        searchDropdown.style.zIndex = '3000';
    }

    /* =====================================================
       SEARCH INPUT EVENTS
    ===================================================== */
    searchInput.addEventListener('focus', async () => {
        await loadSearchData();
        const query = searchInput.value.trim();
        if (!query) {
            searchDropdown.style.display = 'none';
            return;
        }
        const { resultsQP, resultsCode } = filterAndSort(query);
        renderResults(resultsQP, resultsCode);
        positionDropdown();
    });

    searchInput.addEventListener('input', async () => {
        const query = searchInput.value.trim();
        if (!query) {
            searchDropdown.style.display = 'none';
            return;
        }
        await loadSearchData();
        const { resultsQP, resultsCode } = filterAndSort(query);
        renderResults(resultsQP, resultsCode);
        positionDropdown();
    });

    /* =====================================================
       HIDE DROPDOWN ON CLICK OUTSIDE
    ===================================================== */
    document.addEventListener('mousedown', (e) => {
        if (!searchDropdown.contains(e.target) && 
            e.target !== searchInput && 
            !searchInput.contains(e.target)) {
            searchDropdown.style.display = 'none';
        }
    });

    searchInput.addEventListener('blur', () => {
        setTimeout(() => { 
            searchDropdown.style.display = 'none'; 
        }, 200);
    });

    /* =====================================================
       KEYBOARD NAVIGATION
    ===================================================== */
    searchInput.addEventListener('keydown', function (e) {
        const rows = Array.from(searchDropdown.querySelectorAll('.search-result-row'));
        let idx = rows.findIndex(row => row.classList.contains('active'));

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (rows.length) {
                if (idx >= 0) rows[idx].classList.remove('active');
                idx = (idx + 1) % rows.length;
                rows[idx].classList.add('active');
                rows[idx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (rows.length) {
                if (idx >= 0) rows[idx].classList.remove('active');
                idx = (idx - 1 + rows.length) % rows.length;
                rows[idx].classList.add('active');
                rows[idx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (idx >= 0 && rows[idx]) {
                rows[idx].click();
            } else if (rows.length > 0) {
                rows[0].click();
            }
        } else if (e.key === 'Escape') {
            searchDropdown.style.display = 'none';
            searchInput.blur();
        }
    });

    /* =====================================================
       REPOSITION ON SCROLL/RESIZE
    ===================================================== */
    window.addEventListener('scroll', () => {
        if (searchDropdown.style.display === 'block' && window.innerWidth > 899) {
            positionDropdown();
        }
    });

    window.addEventListener('resize', () => {
        if (searchDropdown.style.display === 'block') {
            positionDropdown();
        }
    });
});