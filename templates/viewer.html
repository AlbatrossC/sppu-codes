<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>{{ seo_data.title }}</title>
    <meta name="description" content="{{ seo_data.description }}">
    <meta name="keywords" content="{{ seo_data.keywords }}">
    <meta name="author" content="SPPU Codes Team">
    <meta name="language" content="English">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    <meta name="subject" content="{{ seo_data.subject_name }} Question Papers">
    <meta name="topic" content="Academic Question Papers, SPPU University Papers">
    <meta name="summary" content="Download and view {{ seo_data.subject_name }} question papers online. Access INSEM and ENDSEM papers with our PDF viewer.">

    <link rel="canonical" href="https://sppucodes.vercel.app/questionpapers/{{ subject_name }}">
    <meta name="google-adsense-account" content="ca-pub-6918638598461716">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6918638598461716"
     crossorigin="anonymous"></script>

    <meta property="og:title" content="{{ seo_data.title }}">
    <meta property="og:description" content="{{ seo_data.description }}">
    <meta property="og:url" content="https://sppucodes.vercel.app/questionpapers/{{ subject_name }}">
    <meta property="og:image" content="https://sppucodes.vercel.app/images/logo.png">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="SPPU Codes">
    <meta property="og:locale" content="en_US">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ seo_data.title }}">
    <meta name="twitter:description" content="{{ seo_data.description }}">
    <meta name="twitter:image" content="https://sppucodes.vercel.app/images/logo.png">
    <meta name="twitter:site" content="@sppucodes">
    

    <link href="{{ url_for('get_image', filename='favicon.ico') }}" rel="icon" fetchpriority="high" type="image/x-icon">

    <link href="/static/pdfjs/web/viewer.html" rel="preload" fetchpriority="high" as="document">
    <link href="/static/pdfjs/web/viewer.css" rel="preload" fetchpriority="high" as="style">
    <link href="/static/css/viewer.css" rel="stylesheet">
    <link href="/static/pdfjs/web/pdf.worker.js" rel="preload" fetchpriority="high" as="worker">

    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "{{ seo_data.title }}",
        "description": "{{ seo_data.description }}",
        "url": "https://sppucodes.vercel.app/questionpapers/{{ subject_name }}",
        "inLanguage": "en-US",
        "isPartOf": {
            "@type": "WebSite",
            "name": "SPPU Codes",
            "url": "https://sppucodes.vercel.app",
            "publisher": {
                "@type": "Organization",
                "name": "SPPU Codes",
                "url": "https://sppucodes.vercel.app",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://sppucodes.vercel.app/images/logo.png"
                }
            }
        },
        "mainEntity": {
            "@type": "CollectionPage",
            "name": "{{ seo_data.subject_name }} Question Papers Collection",
            "description": "Complete collection of {{ seo_data.subject_name }} question papers including INSEM and ENDSEM papers from SPPU University.",
            "mainContentOfPage": {
                "@type": "ItemList",
                "numberOfItems": {{ pdf_data_for_js | length }},
                "itemListElement": [
                    {% for pdf in pdf_data_for_js %}
                    {
                        "@type": "DigitalDocument",
                        "name": "{{ pdf.filename }}",
                        "description": "{{ seo_data.subject_name }} question paper - {{ pdf.filename }}",
                        "contentUrl": "{{ pdf.url }}",
                        "encodingFormat": "application/pdf",
                        "position": {{ loop.index }},
                        "datePublished": "2024-01-01",
                        "inLanguage": "en-US",
                        "about": {
                            "@type": "Thing",
                            "name": "{{ seo_data.subject_name }}",
                            "description": "Academic subject at Savitribai Phule Pune University"
                        },
                        "publisher": {
                            "@type": "Organization",
                            "name": "SPPU Codes",
                            "url": "https://sppucodes.vercel.app"
                        }
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }
        },
        "breadcrumb": {
            "@type": "BreadcrumbList",
            "itemListElement": [
                {"@type": "ListItem", "position": 1, "name": "Home", "item": "https://sppucodes.vercel.app"},
                {"@type": "ListItem", "position": 2, "name": "Question Papers", "item": "https://sppucodes.vercel.app/questionpapers"},
                {"@type": "ListItem", "position": 3, "name": "{{ seo_data.subject_name }}", "item": "https://sppucodes.vercel.app/questionpapers/{{ subject_name }}"}
            ]
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Course",
        "name": "{{ seo_data.subject_name }}",
        "description": "Comprehensive {{ seo_data.subject_name }} course at Savitribai Phule Pune University. Access question papers, study materials, and examination resources for academic success.",
        "provider": {"@type": "Organization", "name": "Savitribai Phule Pune University", "alternateName": "SPPU", "url": "https://www.unipune.ac.in/"},
        "offers": {"@type": "Offer", "category": "Educational Resource", "price": "0", "priceCurrency": "INR", "availability": "https://schema.org/InStock", "validFrom": "2024-01-01"},
        "hasCourseInstance": {"@type": "CourseInstance", "courseMode": "Online", "courseWorkload": "P4Y", "instructor": {"@type": "Organization", "name": "Savitribai Phule Pune University Faculty"}},
        "educationalCredentialAwarded": "University Degree",
        "numberOfCredits": 4,
        "coursePrerequisites": "High School Diploma or equivalent",
        "hasPart": [
            {% for pdf in pdf_data_for_js %}
            {
                "@type": "LearningResource",
                "name": "{{ pdf.filename }}",
                "description": "{{ seo_data.subject_name }} examination paper - {{ pdf.filename }}",
                "learningResourceType": "Question Paper",
                "educationalUse": "Examination Preparation",
                "url": "{{ pdf.url }}",
                "encodingFormat": "application/pdf",
                "inLanguage": "en"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }
    </script>
</head>
<body>
    <div class="seo-content">
        <h1>{{ seo_data.subject_name }} Question Papers - SPPU University</h1>
        <p>Access and download {{ seo_data.subject_name }} question papers from Savitribai Phule Pune University (SPPU). Our collection includes INSEM (Internal Semester) and ENDSEM (End Semester) exam papers.</p>

        <h2>Available {{ seo_data.subject_name }} Papers</h2>
        <p>We offer {{ pdf_data_for_js | length }} question papers for {{ seo_data.subject_name }}, covering various exam patterns and years. All papers are in PDF format for easy viewing and download.</p>

        <h3>INSEM Papers for {{ seo_data.subject_name }}</h3>
        <p>Prepare for mid-term evaluations with {{ seo_data.subject_name }} INSEM papers, aligned with the SPPU exam pattern and syllabus.</p>

        <h3>ENDSEM Papers for {{ seo_data.subject_name }}</h3>
        <p>Access {{ seo_data.subject_name }} ENDSEM papers covering the entire syllabus, essential for final exam preparation.</p>

        <h2>Online PDF Viewer Features</h2>
        <p>Our PDF viewer enables you to:</p>
        <ul>
            <li>View papers in single or split-screen mode.</li>
            <li>Compare multiple papers simultaneously.</li>
            <li>Use fullscreen mode for better readability.</li>
            <li>Filter by exam type (INSEM/ENDSEM).</li>
            <li>Download papers for offline study.</li>
        </ul>

        <h2>About SPPU Codes</h2>
        <p>SPPU Codes is your resource for SPPU academic materials. We provide easy access to question papers to help students excel.</p>

        <h3>Study Materials for {{ seo_data.subject_name }}</h3>
        <p>{{ seo_data.subject_name }} is a key subject in the SPPU curriculum. Our question paper collection helps students understand exam patterns, practice effectively, and improve academic performance.</p>
        <div>
            <h3>Direct Links to Question Papers:</h3>
            {% for pdf in pdf_data_for_js %}
                <a href="{{ pdf.url }}" download="{{ pdf.filename }}">Download {{ pdf.filename }} ({{ seo_data.subject_name }})</a>
            {% endfor %}
        </div>

        <h2>Relevant Keywords & Topics</h2>
        <p>Explore {{ seo_data.subject_name }} resources including SPPU question papers from Savitribai Phule Pune University. Find INSEM and ENDSEM papers for effective examination preparation. Our platform offers academic resources, a PDF viewer for online study, university question papers, and materials for semester examinations.</p>
    </div>

    <header>
        <div class="header-info">
            <button class="back" id="back-btn" aria-label="Go back to question papers list">
                <svg class="icon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Back
            </button>
            <h1><div class="subject-badge" id="subject-display">{{ seo_data.subject_name }}</div></h1>
        </div>
        <div class="header-center">
            <div class="control-group">
                <label for="pdf-count">Layout:</label>
                <select id="pdf-count" aria-label="Select PDF layout">
                    <option value="1" selected>Single</option>
                    <option value="2">Split (2)</option>
                    <option value="3">Split (3)</option>
                    <option value="4">Grid (4)</option>
                </select>
            </div>
            <div class="control-group">
                <label for="exam-type">Exam:</label>
                <select id="exam-type" aria-label="Select exam type">
                    <option value="insem">INSEM</option>
                    <option value="endsem">ENDSEM</option>
                </select>
            </div>
        </div>
        <div class="header-controls">
            <button class="primary" id="fullscreen-btn" aria-label="Toggle fullscreen mode">
                <svg class="icon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                Fullscreen
            </button>
        </div>
    </header>

    <div class="grid-1" id="pdf-container">
        <div class="no-pdf-message">Loading PDFs...<div class="loader"></div></div>
    </div>
<script>
    'use strict';
    const initialPdfDataFromServer = {{ pdf_data_for_js | tojson | safe }};
    const subjectNameFromServer = {{ seo_data.subject_name | tojson | safe }};

    const DOM = {
        pdfContainer: document.getElementById('pdf-container'),
        subjectDisplay: document.getElementById('subject-display'),
        pdfCount: document.getElementById('pdf-count'),
        examType: document.getElementById('exam-type'),
        fullscreenBtn: document.getElementById('fullscreen-btn'),
        backBtn: document.getElementById('back-btn')
    };

    const state = {
        pdfFiles: [],
        isRendering: false,
        activeObjectURLs: new Map(),
        renderQueue: Promise.resolve(),
        pdfViewerBase: '/static/pdfjs/web/viewer.html',
        serviceWorkerReady: false,
        cachedPdfs: new Set(),
        cacheProgress: { total: 0, completed: 0, failed: 0 },
        preloadComplete: false
    };

    // Service Worker Registration and Management
    const ServiceWorkerManager = {
        async register() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    await navigator.serviceWorker.ready;
                    state.serviceWorkerReady = true;
                    navigator.serviceWorker.addEventListener('message', (event) => this.handleMessage(event));
                    this.cleanCache();
                    console.log('ðŸ“„ PDF Viewer: Service Worker ready for offline caching');
                    return registration;
                } catch (error) {
                    console.warn('ðŸ“„ PDF Viewer: Service Worker unavailable, PDFs will load from network');
                    return null;
                }
            } else {
                console.warn('ðŸ“„ PDF Viewer: Service Worker not supported in this browser');
                return null;
            }
        },

        handleMessage(event) {
            const { type, data } = event.data;
            switch (type) {
                case 'PDF_DOWNLOAD_START':
                    state.cacheProgress.total++;
                    break;
                case 'PDF_DOWNLOAD_COMPLETE':
                    state.cachedPdfs.add(data.url);
                    state.cacheProgress.completed++;
                    break;
                case 'PDF_DOWNLOAD_ERROR':
                    state.cacheProgress.failed++;
                    console.warn(`ðŸ“„ PDF Viewer: Failed to cache ${data.fileName}`);
                    break;
                case 'PDF_CACHE_CHECK':
                    data.cachedUrls.forEach(url => {
                        state.cachedPdfs.add(url);
                    });
                    break;
            }
            
            // Log cache completion summary
            const { total, completed, failed } = state.cacheProgress;
            if (completed + failed === total && total > 0) {
                console.log(`ðŸ“„ PDF Viewer: Cache complete - ${completed} cached, ${failed} failed out of ${total} PDFs`);
            }
        },

        async initiatePdfCaching(pdfUrls) {
            if (!state.serviceWorkerReady || pdfUrls.length === 0) return;
            
            state.cacheProgress = { total: 0, completed: 0, failed: 0 };
            console.log(`ðŸ“„ PDF Viewer: Starting background cache for ${pdfUrls.length} PDFs`);
            
            navigator.serviceWorker.controller?.postMessage({
                type: 'CACHE_PDFS',
                urls: pdfUrls
            });
        },

        async checkCachedPdfs(pdfUrls) {
            if (!state.serviceWorkerReady) return [];
            return new Promise((resolve) => {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = (event) => {
                    resolve(event.data.cachedUrls || []);
                };
                navigator.serviceWorker.controller?.postMessage({
                    type: 'CHECK_CACHED_PDFS',
                    urls: pdfUrls
                }, [messageChannel.port2]);
                setTimeout(() => resolve([]), 1000);
            });
        },

        cleanCache() {
            if (state.serviceWorkerReady) {
                navigator.serviceWorker.controller?.postMessage({ type: 'CLEAN_CACHE' });
            }
        }
    };

    // Efficient PDF preloading with priority queue
    const PreloadManager = {
        preloadQueue: [],
        maxConcurrent: 2,
        activePreloads: 0,

        async preloadPdfViewer() {
            if (state.preloadComplete) return;
            
            return new Promise((resolve) => {
                const preloadIframe = document.createElement('iframe');
                preloadIframe.style.cssText = 'position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none;';
                preloadIframe.setAttribute('aria-hidden', 'true');
                preloadIframe.src = state.pdfViewerBase;
                
                preloadIframe.onload = () => {
                    state.preloadComplete = true;
                    console.log('ðŸ“„ PDF Viewer: PDF.js viewer preloaded');
                    if (preloadIframe.parentNode) preloadIframe.remove();
                    resolve();
                };
                
                preloadIframe.onerror = () => {
                    console.warn('ðŸ“„ PDF Viewer: PDF.js viewer preload failed');
                    if (preloadIframe.parentNode) preloadIframe.remove();
                    resolve();
                };
                
                document.body.appendChild(preloadIframe);
                
                // Fallback cleanup
                setTimeout(() => {
                    if (preloadIframe.parentNode) preloadIframe.remove();
                    resolve();
                }, 3000);
            });
        },

        addToPreloadQueue(pdfUrl, priority = 1) {
            this.preloadQueue.push({ url: pdfUrl, priority });
            this.preloadQueue.sort((a, b) => b.priority - a.priority);
            this.processQueue();
        },

        async processQueue() {
            if (this.activePreloads >= this.maxConcurrent || this.preloadQueue.length === 0) return;
            
            const { url } = this.preloadQueue.shift();
            this.activePreloads++;
            
            try {
                await fetch(url, { cache: 'default' });
            } catch (error) {
                // Silent fail for preloading
            } finally {
                this.activePreloads--;
                this.processQueue();
            }
        }
    };

    const debounce = (func, wait) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    };

    async function loadPdfIntoIframe(iframe, pdfUrl, loader, retryCount = 0) {
        const oldObjectURL = state.activeObjectURLs.get(iframe);
        if (oldObjectURL) {
            URL.revokeObjectURL(oldObjectURL);
            state.activeObjectURLs.delete(iframe);
        }

        try {
            if (!isValidUrl(pdfUrl)) throw new Error('Invalid PDF URL');
            const isCached = state.cachedPdfs.has(pdfUrl);
            
            const response = await fetch(pdfUrl, { cache: isCached ? 'force-cache' : 'default' });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const blob = await response.blob();
            const fileUrlToLoad = URL.createObjectURL(blob);
            state.activeObjectURLs.set(iframe, fileUrlToLoad);
            
            const iframeSrc = `${state.pdfViewerBase}?file=${encodeURIComponent(fileUrlToLoad)}`;
            iframe.src = iframeSrc;

            iframe.onload = () => {
                if (loader && loader.parentNode) loader.remove();
            };
            
            iframe.onerror = () => {
                if (loader && loader.parentNode) loader.remove();
                if (iframe.parentElement) {
                    iframe.parentElement.innerHTML = '<div class="no-pdf-message">Error loading PDF. Please check the URL and network.</div>';
                }
            };
        } catch (error) {
            if (retryCount < 2) {
                setTimeout(() => loadPdfIntoIframe(iframe, pdfUrl, loader, retryCount + 1), 1000);
                return;
            }
            if (loader && loader.parentNode) loader.remove();
            if (iframe.parentElement) {
                iframe.parentElement.innerHTML = '<div class="no-pdf-message">Error loading PDF. Please try again or check your network.</div>';
            }
            console.warn(`ðŸ“„ PDF Viewer: Failed to load ${pdfUrl.split('/').pop()} after ${retryCount + 1} attempts`);
        }
    }

    function isValidUrl(url) {
        try {
            new URL(url);
            return url.toLowerCase().endsWith('.pdf');
        } catch {
            return false;
        }
    }

    function updateSubjectDisplay() {
        DOM.subjectDisplay.textContent = subjectNameFromServer || "Subject";
    }

    const filterPDFs = (() => {
        const cache = new Map();
        const maxSize = 5;
        return (examType) => {
            const key = examType.toLowerCase();
            if (cache.has(key)) {
                const val = cache.get(key);
                cache.delete(key);
                cache.set(key, val);
                return val;
            }
            const result = state.pdfFiles.filter(file => file.date.toLowerCase().includes(key));
            if (cache.size >= maxSize) cache.delete(cache.keys().next().value);
            cache.set(key, result);
            return result;
        };
    })();

    async function renderPDFs() {
        if (state.isRendering) return;
        state.isRendering = true;

        await state.renderQueue;
        state.renderQueue = new Promise(async (resolve) => {
            const count = parseInt(DOM.pdfCount.value, 10);
            const examType = DOM.examType.value;
            const filteredData = filterPDFs(examType);

            DOM.pdfContainer.querySelectorAll('iframe').forEach(iframe => {
                const oldObjectURL = state.activeObjectURLs.get(iframe);
                if (oldObjectURL) {
                    URL.revokeObjectURL(oldObjectURL);
                    state.activeObjectURLs.delete(iframe);
                }
                iframe.remove();
            });

            DOM.pdfContainer.className = `grid-${count}`;
            DOM.pdfContainer.innerHTML = filteredData.length ? '' : '<div class="no-pdf-message">No papers for this filter.</div>';

            if (!filteredData.length) {
                state.isRendering = false;
                resolve();
                return;
            }

            const fragment = document.createDocumentFragment();
            const maxRender = Math.min(count, filteredData.length);

            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = 'pdf-viewer';
                if (i < maxRender) {
                    const loader = document.createElement('div');
                    loader.className = 'loader-container';
                    loader.innerHTML = '<div class="loader"></div>';
                    div.appendChild(loader);

                    const selector = createPaperSelector(filteredData, i, `viewer-${i}`);
                    div.appendChild(selector);

                    const iframe = document.createElement('iframe');
                    iframe.title = `PDF Viewer ${i + 1} - ${filteredData[i].originalFilename}`;
                    div.appendChild(iframe);
                    loadPdfIntoIframe(iframe, filteredData[i].link, loader);

                    // Preload next PDFs with lower priority
                    if (i + 1 < filteredData.length) {
                        PreloadManager.addToPreloadQueue(filteredData[i + 1].link, 0.5);
                    }
                } else {
                    div.innerHTML = '<div class="no-more-papers">No additional paper for this slot.</div>';
                }
                fragment.appendChild(div);
            }
            DOM.pdfContainer.appendChild(fragment);
            state.isRendering = false;
            resolve();
        });
    }

    function createPaperSelector(data, initialIndex, viewerId) {
        const selectorContainer = document.createElement('div');
        selectorContainer.className = 'paper-selector';

        const label = document.createElement('label');
        label.className = 'paper-selector-label';
        label.textContent = 'Paper:';
        const selectId = `paper-select-${viewerId}`;
        label.htmlFor = selectId;

        const select = document.createElement('select');
        select.id = selectId;
        select.setAttribute('aria-label', `Select paper for viewer ${viewerId.split('-')[1] + 1}`);
        select.size = 1;
        select.addEventListener('focus', () => { select.size = Math.min(5, data.length || 1); });
        select.addEventListener('blur', () => { select.size = 1; });
        select.addEventListener('change', () => { select.size = 1; });

        data.forEach((item, idx) => {
            const option = document.createElement('option');
            option.value = idx;
            option.textContent = item.date;
            if (idx === initialIndex) option.selected = true;
            select.appendChild(option);
        });

        select.addEventListener('change', debounce(async (e) => {
            const idx = parseInt(e.target.value, 10);
            const pdfUrl = data[idx].link;
            const viewerDiv = selectorContainer.closest('.pdf-viewer');
            const iframe = viewerDiv.querySelector('iframe');
            if (!iframe) return;
            
            iframe.title = `PDF Viewer ${viewerId.split('-')[1] + 1} - ${data[idx].originalFilename}`;

            const loader = document.createElement('div');
            loader.className = 'loader-container';
            loader.innerHTML = '<div class="loader"></div>';
            viewerDiv.insertBefore(loader, iframe);
            await loadPdfIntoIframe(iframe, pdfUrl, loader);
        }, 150));

        selectorContainer.appendChild(label);
        selectorContainer.appendChild(select);
        return selectorContainer;
    }

    function toggleFullscreen() {
        if (document.fullscreenElement) {
            document.exitFullscreen().catch(err => console.error("ðŸ“„ PDF Viewer: Error exiting fullscreen:", err));
        } else {
            document.documentElement.requestFullscreen({ navigationUI: 'hide' }).catch(err => console.error("ðŸ“„ PDF Viewer: Error entering fullscreen:", err));
        }
    }

    function updateFullscreenButton() {
        DOM.fullscreenBtn.innerHTML = document.fullscreenElement ?
            `<svg class="icon" viewBox="0 0 24 24"><path d="M4 14h6m0 0v6m0-6l-7 7m17-11h-6m0 0V4m0 6l7-7"/></svg> Exit Fullscreen` :
            `<svg class="icon" viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg> Fullscreen`;
    }

    function setupEventListeners() {
        const debouncedRender = debounce(renderPDFs, 250);
        DOM.pdfCount.addEventListener('change', debouncedRender);
        DOM.examType.addEventListener('change', debouncedRender);
        DOM.fullscreenBtn.addEventListener('click', toggleFullscreen);
        DOM.backBtn.addEventListener('click', () => window.location.href = '/questionpapers');
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.fullscreenElement) {
                document.exitFullscreen().catch(err => console.error("ðŸ“„ PDF Viewer: Error exiting fullscreen on escape:", err));
            }
        });
    }

    async function init() {
        console.log('ðŸ“„ PDF Viewer: Initializing...');
        updateSubjectDisplay();
        setupEventListeners();

        // Start preloading PDF.js viewer immediately
        PreloadManager.preloadPdfViewer();

        await ServiceWorkerManager.register();

        if (initialPdfDataFromServer && initialPdfDataFromServer.length > 0) {
            state.pdfFiles = initialPdfDataFromServer
                .map(pdfObject => {
                    if (!pdfObject || typeof pdfObject.filename !== 'string' || typeof pdfObject.url !== 'string' || !isValidUrl(pdfObject.url)) {
                        return null;
                    }
                    return {
                        date: pdfObject.filename.replace(/\.pdf$/i, ''),
                        link: pdfObject.url,
                        originalFilename: pdfObject.filename
                    };
                })
                .filter(item => item !== null)
                .sort((a, b) => b.date.localeCompare(a.date));

            const hasInsem = state.pdfFiles.some(file => file.date.toLowerCase().includes('insem'));
            const hasEndsem = state.pdfFiles.some(file => file.date.toLowerCase().includes('endsem'));

            DOM.examType.querySelector('option[value="insem"]').disabled = !hasInsem;
            DOM.examType.querySelector('option[value="endsem"]').disabled = !hasEndsem;

            if (hasInsem) DOM.examType.value = 'insem';
            else if (hasEndsem) DOM.examType.value = 'endsem';

            console.log(`ðŸ“„ PDF Viewer: Loaded ${state.pdfFiles.length} papers for ${subjectNameFromServer || 'this subject'}`);

            const pdfUrls = state.pdfFiles.map(file => file.link);
            const cachedUrls = await ServiceWorkerManager.checkCachedPdfs(pdfUrls);
            cachedUrls.forEach(url => {
                state.cachedPdfs.add(url);
            });

            const uncachedUrls = pdfUrls.filter(url => !state.cachedPdfs.has(url));
            if (uncachedUrls.length > 0) {
                ServiceWorkerManager.initiatePdfCaching(uncachedUrls);
            } else if (cachedUrls.length > 0) {
                console.log(`ðŸ“„ PDF Viewer: ${cachedUrls.length} PDFs already cached`);
            }

            renderPDFs();
        } else {
            DOM.pdfContainer.innerHTML = '<div class="no-pdf-message">No question papers found for this subject.</div>';
            DOM.subjectDisplay.textContent = subjectNameFromServer || 'No Subject';
            console.warn('ðŸ“„ PDF Viewer: No PDF data available');
        }
    }

    window.addEventListener('beforeunload', () => {
        state.activeObjectURLs.forEach(url => URL.revokeObjectURL(url));
        state.activeObjectURLs.clear();
    });

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>