<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <script>
    (function(){
        window.IS_MOBILE_DEVICE=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<768;
    })();
    </script>
    <title>{{ seo_data.title }}</title>
    <meta name="description" content="{{ seo_data.description }}">
    <meta name="keywords" content="{{ seo_data.keywords }}">
    <meta name="author" content="SPPU Codes Team">
    <meta name="language" content="English">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    <meta name="subject" content="{{ seo_data.subject_name }} Question Papers">
    <meta name="topic" content="Academic Question Papers, SPPU University Papers">
    <meta name="summary" content="Download and view {{ seo_data.subject_name }} question papers online. Access INSEM and ENDSEM papers with our PDF viewer.">

    <link rel="canonical" href="https://sppucodes.vercel.app/question-papers/{{ subject_name }}">
    <script>
    if(!window.IS_MOBILE_DEVICE){
        document.write('<meta name="google-adsense-account" content="ca-pub-6918638598461716">');
        document.write('<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6918638598461716" crossorigin="anonymous"><\/script>');
    }
    </script>

    <meta property="og:title" content="{{ seo_data.title }}">
    <meta property="og:description" content="{{ seo_data.description }}">
    <meta property="og:url" content="https://sppucodes.vercel.app/question-papers/{{ subject_name }}">
    <meta property="og:image" content="https://sppucodes.vercel.app/images/logo.png">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="SPPU Codes">
    <meta property="og:locale" content="en_US">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ seo_data.title }}">
    <meta name="twitter:description" content="{{ seo_data.description }}">
    <meta name="twitter:image" content="https://sppucodes.vercel.app/images/logo.png">
    <meta name="twitter:site" content="@sppucodes">
    

    <link href="{{ url_for('get_image', filename='favicon.ico') }}" rel="icon" fetchpriority="high" type="image/x-icon">

    <link href="/static/pdfjs/web/viewer.html" rel="preload" fetchpriority="high" as="document">
    <link href="/static/pdfjs/web/viewer.css" rel="preload" fetchpriority="high" as="style">
    <link href="{{ url_for('static', filename='css/viewer.css') }}?v=2.1" rel="stylesheet">
    <link href="/static/pdfjs/web/pdf.worker.js" rel="preload" fetchpriority="high" as="worker">

    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "{{ seo_data.title }}",
        "description": "{{ seo_data.description }}",
        "url": "https://sppucodes.vercel.app/question-papers/{{ subject_name }}",
        "inLanguage": "en-US",
        "isPartOf": {
            "@type": "WebSite",
            "name": "SPPU Codes",
            "url": "https://sppucodes.vercel.app",
            "publisher": {
                "@type": "Organization",
                "name": "SPPU Codes",
                "url": "https://sppucodes.vercel.app",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://sppucodes.vercel.app/images/logo.png"
                }
            }
        },
        "mainEntity": {
            "@type": "CollectionPage",
            "name": "{{ seo_data.subject_name }} Question Papers Collection",
            "description": "Complete collection of {{ seo_data.subject_name }} question papers including INSEM and ENDSEM papers from SPPU University.",
            "mainContentOfPage": {
                "@type": "ItemList",
                "numberOfItems": {{ pdf_data_for_js | length }},
                "itemListElement": [
                    {% for pdf in pdf_data_for_js %}
                    {
                        "@type": "DigitalDocument",
                        "name": "{{ pdf.filename }}",
                        "description": "{{ seo_data.subject_name }} question paper - {{ pdf.filename }}",
                        "contentUrl": "{{ pdf.url }}",
                        "encodingFormat": "application/pdf",
                        "position": {{ loop.index }},
                        "datePublished": "2024-01-01",
                        "inLanguage": "en-US",
                        "about": {
                            "@type": "Thing",
                            "name": "{{ seo_data.subject_name }}",
                            "description": "Academic subject at Savitribai Phule Pune University"
                        },
                        "publisher": {
                            "@type": "Organization",
                            "name": "SPPU Codes",
                            "url": "https://sppucodes.vercel.app"
                        }
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }
        },
        "breadcrumb": {
            "@type": "BreadcrumbList",
            "itemListElement": [
                {"@type": "ListItem", "position": 1, "name": "Home", "item": "https://sppucodes.vercel.app"},
                {"@type": "ListItem", "position": 2, "name": "Question Papers", "item": "https://sppucodes.vercel.app/question-papers"},
                {"@type": "ListItem", "position": 3, "name": "{{ seo_data.subject_name }}", "item": "https://sppucodes.vercel.app/question-papers/{{ subject_name }}"}
            ]
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Course",
        "name": "{{ seo_data.subject_name }}",
        "description": "Comprehensive {{ seo_data.subject_name }} course at Savitribai Phule Pune University. Access question papers, study materials, and examination resources for academic success.",
        "provider": {"@type": "Organization", "name": "Savitribai Phule Pune University", "alternateName": "SPPU", "url": "https://www.unipune.ac.in/"},
        "offers": {"@type": "Offer", "category": "Educational Resource", "price": "0", "priceCurrency": "INR", "availability": "https://schema.org/InStock", "validFrom": "2024-01-01"},
        "hasCourseInstance": {"@type": "CourseInstance", "courseMode": "Online", "courseWorkload": "P4Y", "instructor": {"@type": "Organization", "name": "Savitribai Phule Pune University Faculty"}},
        "educationalCredentialAwarded": "University Degree",
        "numberOfCredits": 4,
        "coursePrerequisites": "High School Diploma or equivalent",
        "hasPart": [
            {% for pdf in pdf_data_for_js %}
            {
                "@type": "LearningResource",
                "name": "{{ pdf.filename }}",
                "description": "{{ seo_data.subject_name }} examination paper - {{ pdf.filename }}",
                "learningResourceType": "Question Paper",
                "educationalUse": "Examination Preparation",
                "url": "{{ pdf.url }}",
                "encodingFormat": "application/pdf",
                "inLanguage": "en"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }
    </script>
</head>
<body>
    <div id="rotation-prompt" class="rotation-prompt" style="display: none;">
        <div class="rotation-content">
            <svg class="rotation-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                <path d="M12 18h.01"></path>
            </svg>
            <p>Please rotate your device horizontally for split view</p>
            <button class="primary" id="dismiss-rotation">Dismiss</button>
        </div>
    </div>

    <div class="seo-content">
        <h1>{{ seo_data.subject_name }} Question Papers - SPPU University</h1>
        <p>Access and download {{ seo_data.subject_name }} question papers from Savitribai Phule Pune University (SPPU). Our collection includes INSEM (Internal Semester) and ENDSEM (End Semester) exam papers.</p>

        <h2>Available {{ seo_data.subject_name }} Papers</h2>
        <p>We offer {{ pdf_data_for_js | length }} question papers for {{ seo_data.subject_name }}, covering various exam patterns and years. All papers are in PDF format for easy viewing and download.</p>

        <h3>INSEM Papers for {{ seo_data.subject_name }}</h3>
        <p>Prepare for mid-term evaluations with {{ seo_data.subject_name }} INSEM papers, aligned with the SPPU exam pattern and syllabus.</p>

        <h3>ENDSEM Papers for {{ seo_data.subject_name }}</h3>
        <p>Access {{ seo_data.subject_name }} ENDSEM papers covering the entire syllabus, essential for final exam preparation.</p>

        <h2>Online PDF Viewer Features</h2>
        <p>Our PDF viewer enables you to:</p>
        <ul>
            <li>View papers in single or split-screen mode.</li>
            <li>Compare multiple papers simultaneously.</li>
            <li>Use fullscreen mode for better readability.</li>
            <li>Filter by exam type (INSEM/ENDSEM).</li>
            <li>Download papers for offline study.</li>
        </ul>

        <h2>About SPPU Codes</h2>
        <p>SPPU Codes is your resource for SPPU academic materials. We provide easy access to question papers to help students excel.</p>

        <h3>Study Materials for {{ seo_data.subject_name }}</h3>
        <p>{{ seo_data.subject_name }} is a key subject in the SPPU curriculum. Our question paper collection helps students understand exam patterns, practice effectively, and improve academic performance.</p>
        <div>
            <h3>Direct Links to Question Papers:</h3>
            {% for pdf in pdf_data_for_js %}
                <a href="{{ pdf.url }}" download="{{ pdf.filename }}">Download {{ pdf.filename }} ({{ seo_data.subject_name }})</a>
            {% endfor %}
        </div>

        <h2>Relevant Keywords & Topics</h2>
        <p>Explore {{ seo_data.subject_name }} resources including SPPU question papers from Savitribai Phule Pune University. Find INSEM and ENDSEM papers for effective examination preparation. Our platform offers academic resources, a PDF viewer for online study, university question papers, and materials for semester examinations.</p>
    </div>

    <header>
        <div class="header-info">
            <button class="back" id="back-btn" aria-label="Go back to question papers list">
                <svg class="icon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Back
            </button>
            <h1><div class="subject-badge" id="subject-display">{{ seo_data.subject_name }}</div></h1>
        </div>
        <div class="header-center">
            <div class="control-group">
                <label>Layout:</label>
                <div class="custom-dropdown" id="pdf-count-dropdown" data-value="1">
                    <div class="dropdown-selected">
                        <span class="dropdown-text">Single</span>
                        <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="dropdown-options">
                        <div class="dropdown-option selected" data-value="1">Single</div>
                        <div class="dropdown-option" data-value="2">Split (2)</div>
                        <div class="dropdown-option" data-value="3">Split (3)</div>
                        <div class="dropdown-option" data-value="4">Grid (4)</div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <label>Exam:</label>
                <div class="custom-dropdown" id="exam-type-dropdown" data-value="endsem">
                    <div class="dropdown-selected">
                        <span class="dropdown-text">ENDSEM</span>
                        <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="dropdown-options">
                        <div class="dropdown-option" data-value="insem">INSEM</div>
                        <div class="dropdown-option selected" data-value="endsem">ENDSEM</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-controls">
            <button class="primary" id="fullscreen-btn" aria-label="Toggle fullscreen mode">
                <svg class="icon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                Fullscreen
            </button>
        </div>
    </header>

    <div class="grid-1" id="pdf-container">
        <div class="no-pdf-message">Loading PDFs...<div class="loader"></div></div>
    </div>
<script>
    'use strict';

    var initialPdfDataFromServer = {{ pdf_data_for_js | tojson | safe }};
    var subjectNameFromServer = {{ seo_data.subject_name | tojson | safe }};

    // Custom Dropdown Component
    var CustomDropdown = {
        init: function(element, onChange) {
            var self = this;
            var selected = element.querySelector('.dropdown-selected');
            var options = element.querySelector('.dropdown-options');
            var allOptions = element.querySelectorAll('.dropdown-option');
            
            element._getValue = function() {
                return element.getAttribute('data-value');
            };
            
            element._setValue = function(value, triggerChange) {
                var option = element.querySelector('.dropdown-option[data-value="' + value + '"]');
                if (option && !option.classList.contains('disabled')) {
                    element.setAttribute('data-value', value);
                    element.querySelector('.dropdown-text').textContent = option.textContent;
                    allOptions.forEach(function(opt) { opt.classList.remove('selected'); });
                    option.classList.add('selected');
                    if (triggerChange && onChange) onChange(value);
                }
            };
            
            element._setDisabled = function(value, disabled) {
                var option = element.querySelector('.dropdown-option[data-value="' + value + '"]');
                if (option) {
                    if (disabled) option.classList.add('disabled');
                    else option.classList.remove('disabled');
                }
            };
            
            selected.addEventListener('click', function(e) {
                e.stopPropagation();
                var isOpen = element.classList.contains('open');
                self.closeAll();
                if (!isOpen) element.classList.add('open');
            });
            
            allOptions.forEach(function(option) {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (option.classList.contains('disabled')) return;
                    var value = option.getAttribute('data-value');
                    element._setValue(value, true);
                    element.classList.remove('open');
                });
            });
            
            return element;
        },
        
        closeAll: function() {
            document.querySelectorAll('.custom-dropdown.open').forEach(function(dd) {
                dd.classList.remove('open');
            });
        }
    };
    
    document.addEventListener('click', function() {
        CustomDropdown.closeAll();
    });

    var DOM = {
        pdfContainer: document.getElementById('pdf-container'),
        subjectDisplay: document.getElementById('subject-display'),
        pdfCountDropdown: null,
        examTypeDropdown: null,
        fullscreenBtn: document.getElementById('fullscreen-btn'),
        backBtn: document.getElementById('back-btn')
    };

    var state = {
        pdfFiles: [],
        isRendering: false,
        activeObjectURLs: new Map(),
        renderQueue: Promise.resolve(),
        pdfViewerBase: '/static/pdfjs/web/viewer.html',
        serviceWorkerReady: false,
        cachedPdfs: new Set(),
        cacheProgress: { total: 0, completed: 0, failed: 0 },
        preloadComplete: false
    };

    // Service Worker Manager
    var ServiceWorkerManager = {
        register: function() {
            var self = this;
            if ('serviceWorker' in navigator) {
                return navigator.serviceWorker.register('/sw.js')
                    .then(function() {
                        return navigator.serviceWorker.ready;
                    })
                    .then(function(registration) {
                        state.serviceWorkerReady = true;
                        navigator.serviceWorker.addEventListener('message', function(e) { self.handleMessage(e); });
                        self.cleanCache();
                        console.log('PDF Viewer: Service Worker ready for offline caching');
                        return registration;
                    })
                    .catch(function(error) {
                        console.warn('PDF Viewer: Service Worker unavailable, PDFs will load from network');
                        return null;
                    });
            }
            console.warn('PDF Viewer: Service Worker not supported in this browser');
            return Promise.resolve(null);
        },

        handleMessage: function(event) {
            var type = event.data.type;
            var data = event.data.data;
            switch (type) {
                case 'PDF_DOWNLOAD_START':
                    state.cacheProgress.total++;
                    break;
                case 'PDF_DOWNLOAD_COMPLETE':
                    state.cachedPdfs.add(data.url);
                    state.cacheProgress.completed++;
                    break;
                case 'PDF_DOWNLOAD_ERROR':
                    state.cacheProgress.failed++;
                    console.warn('PDF Viewer: Failed to cache ' + data.fileName);
                    break;
                case 'PDF_CACHE_CHECK':
                    data.cachedUrls.forEach(function(url) {
                        state.cachedPdfs.add(url);
                    });
                    break;
            }
            var cp = state.cacheProgress;
            if (cp.completed + cp.failed === cp.total && cp.total > 0) {
                console.log('PDF Viewer: Cache complete - ' + cp.completed + ' cached, ' + cp.failed + ' failed out of ' + cp.total + ' PDFs');
            }
        },

        initiatePdfCaching: function(pdfUrls) {
            if (!state.serviceWorkerReady || pdfUrls.length === 0) return;
            state.cacheProgress = { total: 0, completed: 0, failed: 0 };
            console.log('PDF Viewer: Starting background cache for ' + pdfUrls.length + ' PDFs');
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CACHE_PDFS', urls: pdfUrls });
            }
        },

        checkCachedPdfs: function(pdfUrls) {
            if (!state.serviceWorkerReady) return Promise.resolve([]);
            return new Promise(function(resolve) {
                var messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = function(event) {
                    resolve(event.data.cachedUrls || []);
                };
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'CHECK_CACHED_PDFS', urls: pdfUrls }, [messageChannel.port2]);
                }
                setTimeout(function() { resolve([]); }, 1000);
            });
        },

        cleanCache: function() {
            if (state.serviceWorkerReady && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CLEAN_CACHE' });
            }
        }
    };

    // Preload Manager
    var PreloadManager = {
        preloadQueue: [],
        maxConcurrent: 2,
        activePreloads: 0,

        preloadPdfViewer: function() {
            if (state.preloadComplete) return Promise.resolve();
            return new Promise(function(resolve) {
                var preloadIframe = document.createElement('iframe');
                preloadIframe.style.cssText = 'position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none;';
                preloadIframe.setAttribute('aria-hidden', 'true');
                preloadIframe.src = state.pdfViewerBase;
                
                preloadIframe.onload = function() {
                    state.preloadComplete = true;
                    console.log('PDF Viewer: PDF.js viewer preloaded');
                    if (preloadIframe.parentNode) preloadIframe.remove();
                    resolve();
                };
                
                preloadIframe.onerror = function() {
                    console.warn('PDF Viewer: PDF.js viewer preload failed');
                    if (preloadIframe.parentNode) preloadIframe.remove();
                    resolve();
                };
                
                document.body.appendChild(preloadIframe);
                setTimeout(function() {
                    if (preloadIframe.parentNode) preloadIframe.remove();
                    resolve();
                }, 3000);
            });
        },

        addToPreloadQueue: function(pdfUrl, priority) {
            var self = this;
            priority = priority || 1;
            this.preloadQueue.push({ url: pdfUrl, priority: priority });
            this.preloadQueue.sort(function(a, b) { return b.priority - a.priority; });
            this.processQueue();
        },

        processQueue: function() {
            var self = this;
            if (this.activePreloads >= this.maxConcurrent || this.preloadQueue.length === 0) return;
            var item = this.preloadQueue.shift();
            this.activePreloads++;
            fetch(item.url, { cache: 'default' })
                .catch(function() {})
                .finally(function() {
                    self.activePreloads--;
                    self.processQueue();
                });
        }
    };

    function debounce(func, wait) {
        var timeout;
        return function() {
            var args = arguments;
            var context = this;
            clearTimeout(timeout);
            timeout = setTimeout(function() { func.apply(context, args); }, wait);
        };
    }

    function formatPdfName(filename) {
        var name = filename.replace(/\.pdf$/i, '');
        var parts = name.split('-');
        
        var year = '';
        var type = '';
        var months = [];
        var monthNames = ['jan', 'january', 'feb', 'february', 'mar', 'march', 'apr', 'april', 'may', 'jun', 'june', 'jul', 'july', 'aug', 'august', 'sep', 'sept', 'september', 'oct', 'october', 'nov', 'november', 'dec', 'december'];

        // Find year
        var yearMatch = name.match(/\d{4}/);
        if (yearMatch) year = yearMatch[0];

        // Find type
        if (name.toLowerCase().includes('endsem')) type = 'Endsem';
        else if (name.toLowerCase().includes('insem')) type = 'Insem';

        // Find months
        parts.forEach(function(part) {
            if (monthNames.includes(part.toLowerCase())) {
                months.push(part.charAt(0).toUpperCase() + part.slice(1));
            }
        });

        if (!year && !type && months.length === 0) return name;

        var result = [];
        if (year) result.push(year);
        if (months.length) result.push(months.join(' '));
        if (type) result.push(type);

        return result.join(' ');
    }

    function loadPdfIntoIframe(iframe, pdfUrl, loader, retryCount) {
        retryCount = retryCount || 0;
        var oldObjectURL = state.activeObjectURLs.get(iframe);
        if (oldObjectURL) {
            URL.revokeObjectURL(oldObjectURL);
            state.activeObjectURLs.delete(iframe);
        }

        if (!isValidUrl(pdfUrl)) {
            showPdfError(iframe, loader, 'Invalid PDF URL');
            return Promise.resolve();
        }

        var isCached = state.cachedPdfs.has(pdfUrl);
        return fetch(pdfUrl, { cache: isCached ? 'force-cache' : 'default' })
            .then(function(response) {
                if (!response.ok) throw new Error('HTTP ' + response.status);
                return response.blob();
            })
            .then(function(blob) {
                var fileUrlToLoad = URL.createObjectURL(blob);
                state.activeObjectURLs.set(iframe, fileUrlToLoad);
                iframe.src = state.pdfViewerBase + '?file=' + encodeURIComponent(fileUrlToLoad);
                iframe.onload = function() {
                    if (loader && loader.parentNode) loader.remove();
                };
                iframe.onerror = function() {
                    showPdfError(iframe, loader, 'Error loading PDF. Please check the URL and network.');
                };
            })
            .catch(function(error) {
                if (retryCount < 2) {
                    return new Promise(function(resolve) {
                        setTimeout(function() {
                            resolve(loadPdfIntoIframe(iframe, pdfUrl, loader, retryCount + 1));
                        }, 1000);
                    });
                }
                showPdfError(iframe, loader, 'Error loading PDF. Please try again or check your network.');
                console.warn('PDF Viewer: Failed to load ' + pdfUrl.split('/').pop() + ' after ' + (retryCount + 1) + ' attempts');
            });
    }

    function showPdfError(iframe, loader, message) {
        if (loader && loader.parentNode) loader.remove();
        if (iframe.parentElement) {
            var errorMsg = document.createElement('div');
            errorMsg.className = 'no-pdf-message';
            errorMsg.textContent = message;
            iframe.parentElement.innerHTML = '';
            iframe.parentElement.appendChild(errorMsg);
        }
    }

    function isValidUrl(url) {
        try {
            new URL(url);
            return url.toLowerCase().endsWith('.pdf');
        } catch (e) {
            return false;
        }
    }

    function updateSubjectDisplay() {
        DOM.subjectDisplay.textContent = subjectNameFromServer || "Subject";
    }

    var filterPDFs = (function() {
        var cache = new Map();
        var maxSize = 5;
        return function(examType) {
            var key = examType.toLowerCase();
            if (cache.has(key)) {
                var val = cache.get(key);
                cache.delete(key);
                cache.set(key, val);
                return val;
            }
            var result = state.pdfFiles.filter(function(file) {
                return file.originalFilename.toLowerCase().includes(key);
            });
            if (cache.size >= maxSize) cache.delete(cache.keys().next().value);
            cache.set(key, result);
            return result;
        };
    })();

    function renderPDFs() {
        if (state.isRendering) return;
        state.isRendering = true;

        state.renderQueue = state.renderQueue.then(function() {
            return new Promise(function(resolve) {
                var count = parseInt(DOM.pdfCountDropdown._getValue(), 10);
                var examType = DOM.examTypeDropdown._getValue();
                var filteredData = filterPDFs(examType);

                DOM.pdfContainer.querySelectorAll('iframe').forEach(function(iframe) {
                    var oldObjectURL = state.activeObjectURLs.get(iframe);
                    if (oldObjectURL) {
                        URL.revokeObjectURL(oldObjectURL);
                        state.activeObjectURLs.delete(iframe);
                    }
                    iframe.remove();
                });

                DOM.pdfContainer.className = 'grid-' + count;
                
                if (!filteredData.length) {
                    DOM.pdfContainer.innerHTML = '<div class="no-pdf-message">No papers for this filter.</div>';
                    state.isRendering = false;
                    resolve();
                    return;
                }

                DOM.pdfContainer.innerHTML = '';
                var fragment = document.createDocumentFragment();
                var maxRender = Math.min(count, filteredData.length);

                for (var i = 0; i < count; i++) {
                    var div = document.createElement('div');
                    div.className = 'pdf-viewer';
                    
                    if (i < maxRender) {
                        var loader = document.createElement('div');
                        loader.className = 'loader-container';
                        loader.innerHTML = '<div class="loader"></div>';
                        div.appendChild(loader);

                        var selector = createPaperSelector(filteredData, i, 'viewer-' + i);
                        div.appendChild(selector);

                        var iframe = document.createElement('iframe');
                        iframe.title = 'PDF Viewer ' + (i + 1) + ' - ' + filteredData[i].originalFilename;
                        div.appendChild(iframe);
                        loadPdfIntoIframe(iframe, filteredData[i].link, loader);

                        if (i + 1 < filteredData.length) {
                            PreloadManager.addToPreloadQueue(filteredData[i + 1].link, 0.5);
                        }
                    } else {
                        div.innerHTML = '<div class="no-more-papers">No additional paper for this slot.</div>';
                    }
                    fragment.appendChild(div);
                }
                DOM.pdfContainer.appendChild(fragment);
                state.isRendering = false;
                resolve();
            });
        });
    }

    function createPaperSelector(data, initialIndex, viewerId) {
        var selectorContainer = document.createElement('div');
        selectorContainer.className = 'paper-selector';

        var label = document.createElement('label');
        label.className = 'paper-selector-label';
        label.textContent = 'Paper:';

        var dropdown = document.createElement('div');
        dropdown.className = 'custom-dropdown paper-dropdown';
        dropdown.setAttribute('data-value', initialIndex);
        
        var selectedDiv = document.createElement('div');
        selectedDiv.className = 'dropdown-selected';
        selectedDiv.innerHTML = '<span class="dropdown-text">' + data[initialIndex].date + '</span><svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>';
        
        var optionsDiv = document.createElement('div');
        optionsDiv.className = 'dropdown-options';
        
        data.forEach(function(item, idx) {
            var option = document.createElement('div');
            option.className = 'dropdown-option' + (idx === initialIndex ? ' selected' : '');
            option.setAttribute('data-value', idx);
            option.textContent = item.date;
            optionsDiv.appendChild(option);
        });
        
        dropdown.appendChild(selectedDiv);
        dropdown.appendChild(optionsDiv);
        
        CustomDropdown.init(dropdown, function(idx) {
            idx = parseInt(idx, 10);
            var pdfUrl = data[idx].link;
            var viewerDiv = selectorContainer.closest('.pdf-viewer');
            var iframe = viewerDiv.querySelector('iframe');
            if (!iframe) return;
            
            iframe.title = 'PDF Viewer ' + (parseInt(viewerId.split('-')[1]) + 1) + ' - ' + data[idx].originalFilename;

            var loader = document.createElement('div');
            loader.className = 'loader-container';
            loader.innerHTML = '<div class="loader"></div>';
            viewerDiv.insertBefore(loader, iframe);
            loadPdfIntoIframe(iframe, pdfUrl, loader);
        });

        selectorContainer.appendChild(label);
        selectorContainer.appendChild(dropdown);
        return selectorContainer;
    }

    function toggleFullscreen() {
        if (document.fullscreenElement) {
            document.exitFullscreen().catch(function(err) { console.error("PDF Viewer: Error exiting fullscreen:", err); });
        } else {
            document.documentElement.requestFullscreen({ navigationUI: 'hide' }).catch(function(err) { console.error("PDF Viewer: Error entering fullscreen:", err); });
        }
    }

    function updateFullscreenButton() {
        var isFullscreen = document.fullscreenElement;
        DOM.fullscreenBtn.innerHTML = isFullscreen ?
            '<svg class="icon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M4 14h6m0 0v6m0-6l-7 7m17-11h-6m0 0V4m0 6l7-7"/></svg> Exit Fullscreen' :
            '<svg class="icon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg> Fullscreen';
    }

    function setupEventListeners() {
        var debouncedRender = debounce(renderPDFs, 250);
        
        // Modified handler for layout dropdown
        var onLayoutChange = function(val) {
            if (window.IS_MOBILE_DEVICE && val === '2') {
                checkOrientation();
            }
            debouncedRender();
        };

        DOM.pdfCountDropdown = CustomDropdown.init(
            document.getElementById('pdf-count-dropdown'),
            onLayoutChange
        );
        
        DOM.examTypeDropdown = CustomDropdown.init(
            document.getElementById('exam-type-dropdown'),
            debouncedRender
        );
        
        DOM.fullscreenBtn.addEventListener('click', toggleFullscreen);
        DOM.backBtn.addEventListener('click', function() { window.location.href = '/question-papers'; });
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                CustomDropdown.closeAll();
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(function(err) { console.error("PDF Viewer: Error exiting fullscreen on escape:", err); });
                }
            }
        });
    }

    function checkOrientation() {
        var prompt = document.getElementById('rotation-prompt');
        if (window.innerHeight > window.innerWidth) {
            prompt.style.display = 'flex';
        } else {
            prompt.style.display = 'none';
        }
    }

    function init() {
        console.log('PDF Viewer: Initializing...');
        
        updateSubjectDisplay();
        setupEventListeners();
        PreloadManager.preloadPdfViewer();

        if (window.IS_MOBILE_DEVICE) {
            console.log('PDF Viewer: Mobile device detected, adjusting layout options');
            // Hide options 3 and 4 for mobile
            var layoutDropdown = document.getElementById('pdf-count-dropdown');
            var options = layoutDropdown.querySelectorAll('.dropdown-option');
            options.forEach(function(opt) {
                var val = opt.getAttribute('data-value');
                if (val === '3' || val === '4') {
                    opt.style.display = 'none';
                }
            });

            // Listen for orientation changes to hide prompt
            window.addEventListener('resize', function() {
                if (DOM.pdfCountDropdown && DOM.pdfCountDropdown._getValue() === '2') {
                    if (window.innerWidth > window.innerHeight) {
                        document.getElementById('rotation-prompt').style.display = 'none';
                    }
                }
            });
            
            document.getElementById('dismiss-rotation').addEventListener('click', function() {
                document.getElementById('rotation-prompt').style.display = 'none';
            });
        }

        ServiceWorkerManager.register().then(function() {
            if (initialPdfDataFromServer && initialPdfDataFromServer.length > 0) {
                state.pdfFiles = initialPdfDataFromServer
                    .map(function(pdfObject) {
                        if (!pdfObject || typeof pdfObject.filename !== 'string' || typeof pdfObject.url !== 'string' || !isValidUrl(pdfObject.url)) {
                            return null;
                        }
                        return {
                            date: formatPdfName(pdfObject.filename),
                            link: pdfObject.url,
                            originalFilename: pdfObject.filename
                        };
                    })
                    .filter(function(item) { return item !== null; })
                    .sort(function(a, b) { return b.date.localeCompare(a.date); });

                var hasInsem = state.pdfFiles.some(function(file) { return file.originalFilename.toLowerCase().includes('insem'); });
                var hasEndsem = state.pdfFiles.some(function(file) { return file.originalFilename.toLowerCase().includes('endsem'); });

                DOM.examTypeDropdown._setDisabled('insem', !hasInsem);
                DOM.examTypeDropdown._setDisabled('endsem', !hasEndsem);

                if (hasEndsem) DOM.examTypeDropdown._setValue('endsem', false);
                else if (hasInsem) DOM.examTypeDropdown._setValue('insem', false);

                console.log('PDF Viewer: Loaded ' + state.pdfFiles.length + ' papers for ' + (subjectNameFromServer || 'this subject'));

                var pdfUrls = state.pdfFiles.map(function(file) { return file.link; });
                return ServiceWorkerManager.checkCachedPdfs(pdfUrls).then(function(cachedUrls) {
                    cachedUrls.forEach(function(url) { state.cachedPdfs.add(url); });
                    var uncachedUrls = pdfUrls.filter(function(url) { return !state.cachedPdfs.has(url); });
                    if (uncachedUrls.length > 0) {
                        ServiceWorkerManager.initiatePdfCaching(uncachedUrls);
                    } else if (cachedUrls.length > 0) {
                        console.log('PDF Viewer: ' + cachedUrls.length + ' PDFs already cached');
                    }
                    renderPDFs();
                });
            } else {
                DOM.pdfContainer.innerHTML = '<div class="no-pdf-message">No question papers found for this subject.</div>';
                DOM.subjectDisplay.textContent = subjectNameFromServer || 'No Subject';
                console.warn('PDF Viewer: No PDF data available');
            }
        });
    }

    window.addEventListener('beforeunload', function() {
        state.activeObjectURLs.forEach(function(url) { URL.revokeObjectURL(url); });
        state.activeObjectURLs.clear();
    });

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>