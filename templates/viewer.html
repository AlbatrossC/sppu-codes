<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>{{ seo_data.title }}</title>
    <meta name="description" content="{{ seo_data.description }}">
    <meta name="keywords" content="{{ seo_data.keywords }}">
    <meta name="author" content="SPPU Codes Team">
    <meta name="language" content="English">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    <meta name="subject" content="{{ seo_data.subject_name }} Question Papers">
    <meta name="topic" content="Academic Question Papers, SPPU University Papers">
    <meta name="summary" content="Download and view {{ seo_data.subject_name }} question papers online. Access INSEM and ENDSEM papers with our PDF viewer.">

    <link rel="canonical" href="https://sppucodes.vercel.app/questionpapers/{{ subject_name }}">

    <meta property="og:title" content="{{ seo_data.title }}">
    <meta property="og:description" content="{{ seo_data.description }}">
    <meta property="og:url" content="https://sppucodes.vercel.app/questionpapers/{{ subject_name }}">
    <meta property="og:image" content="https://sppucodes.vercel.app/images/logo.png">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="SPPU Codes">
    <meta property="og:locale" content="en_US">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ seo_data.title }}">
    <meta name="twitter:description" content="{{ seo_data.description }}">
    <meta name="twitter:image" content="https://sppucodes.vercel.app/images/logo.png">
    <meta name="twitter:site" content="@sppucodes">

    <link href="{{ url_for('get_image', filename='favicon.ico') }}" rel="icon" fetchpriority="high" type="image/x-icon">

    <link href="/static/pdfjs/web/viewer.html" rel="preload" fetchpriority="high" as="document">
    <link href="/static/pdfjs/web/viewer.css" rel="preload" fetchpriority="high" as="style">
    <link href="/static/css/viewer.css" rel="stylesheet">
    <link href="/static/pdfjs/web/viewer.js" rel="preload" fetchpriority="high" as="script">
    <link href="/static/pdfjs/web/pdf.js" rel="preload" fetchpriority="high" as="script">
    <link href="/static/pdfjs/web/pdf.worker.js" rel="preload" fetchpriority="high" as="worker">

    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "{{ seo_data.title }}",
        "description": "{{ seo_data.description }}",
        "url": "https://sppucodes.vercel.app/questionpapers/{{ subject_name }}",
        "inLanguage": "en-US",
        "isPartOf": {
            "@type": "WebSite",
            "name": "SPPU Codes",
            "url": "https://sppucodes.vercel.app",
            "publisher": {
                "@type": "Organization",
                "name": "SPPU Codes",
                "url": "https://sppucodes.vercel.app",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://sppucodes.vercel.app/images/logo.png"
                }
            }
        },
        "mainEntity": {
            "@type": "CollectionPage",
            "name": "{{ seo_data.subject_name }} Question Papers Collection",
            "description": "Complete collection of {{ seo_data.subject_name }} question papers including INSEM and ENDSEM papers from SPPU University.",
            "mainContentOfPage": {
                "@type": "ItemList",
                "numberOfItems": {{ pdf_data_for_js | length }},
                "itemListElement": [
                    {% for pdf in pdf_data_for_js %}
                    {
                        "@type": "DigitalDocument",
                        "name": "{{ pdf.filename }}",
                        "description": "{{ seo_data.subject_name }} question paper - {{ pdf.filename }}",
                        "contentUrl": "{{ pdf.url }}",
                        "encodingFormat": "application/pdf",
                        "position": {{ loop.index }},
                        "datePublished": "2024-01-01",
                        "inLanguage": "en-US",
                        "about": {
                            "@type": "Thing",
                            "name": "{{ seo_data.subject_name }}",
                            "description": "Academic subject at Savitribai Phule Pune University"
                        },
                        "publisher": {
                            "@type": "Organization",
                            "name": "SPPU Codes",
                            "url": "https://sppucodes.vercel.app"
                        }
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }
        },
        "breadcrumb": {
            "@type": "BreadcrumbList",
            "itemListElement": [
                {"@type": "ListItem", "position": 1, "name": "Home", "item": "https://sppucodes.vercel.app"},
                {"@type": "ListItem", "position": 2, "name": "Question Papers", "item": "https://sppucodes.vercel.app/questionpapers"},
                {"@type": "ListItem", "position": 3, "name": "{{ seo_data.subject_name }}", "item": "https://sppucodes.vercel.app/questionpapers/{{ subject_name }}"}
            ]
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Course",
        "name": "{{ seo_data.subject_name }}",
        "description": "Comprehensive {{ seo_data.subject_name }} course at Savitribai Phule Pune University. Access question papers, study materials, and examination resources for academic success.",
        "provider": {"@type": "Organization", "name": "Savitribai Phule Pune University", "alternateName": "SPPU", "url": "https://www.unipune.ac.in/"},
        "offers": {"@type": "Offer", "category": "Educational Resource", "price": "0", "priceCurrency": "INR", "availability": "https://schema.org/InStock", "validFrom": "2024-01-01"},
        "hasCourseInstance": {"@type": "CourseInstance", "courseMode": "Online", "courseWorkload": "P4Y", "instructor": {"@type": "Organization", "name": "Savitribai Phule Pune University Faculty"}},
        "educationalCredentialAwarded": "University Degree",
        "numberOfCredits": 4,
        "coursePrerequisites": "High School Diploma or equivalent",
        "hasPart": [
            {% for pdf in pdf_data_for_js %}
            {
                "@type": "LearningResource",
                "name": "{{ pdf.filename }}",
                "description": "{{ seo_data.subject_name }} examination paper - {{ pdf.filename }}",
                "learningResourceType": "Question Paper",
                "educationalUse": "Examination Preparation",
                "url": "{{ pdf.url }}",
                "encodingFormat": "application/pdf",
                "inLanguage": "en"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }
    </script>
</head>
<body>
    <div class="seo-content">
        <h1>{{ seo_data.subject_name }} Question Papers - SPPU University</h1>
        <p>Access and download {{ seo_data.subject_name }} question papers from Savitribai Phule Pune University (SPPU). Our collection includes INSEM (Internal Semester) and ENDSEM (End Semester) exam papers.</p>

        <h2>Available {{ seo_data.subject_name }} Papers</h2>
        <p>We offer {{ pdf_data_for_js | length }} question papers for {{ seo_data.subject_name }}, covering various exam patterns and years. All papers are in PDF format for easy viewing and download.</p>

        <h3>INSEM Papers for {{ seo_data.subject_name }}</h3>
        <p>Prepare for mid-term evaluations with {{ seo_data.subject_name }} INSEM papers, aligned with the SPPU exam pattern and syllabus.</p>

        <h3>ENDSEM Papers for {{ seo_data.subject_name }}</h3>
        <p>Access {{ seo_data.subject_name }} ENDSEM papers covering the entire syllabus, essential for final exam preparation.</p>

        <h2>Online PDF Viewer Features</h2>
        <p>Our PDF viewer enables you to:</p>
        <ul>
            <li>View papers in single or split-screen mode.</li>
            <li>Compare multiple papers simultaneously.</li>
            <li>Use fullscreen mode for better readability.</li>
            <li>Filter by exam type (INSEM/ENDSEM).</li>
            <li>Download papers for offline study.</li>
        </ul>

        <h2>About SPPU Codes</h2>
        <p>SPPU Codes is your resource for SPPU academic materials. We provide easy access to question papers to help students excel.</p>

        <h3>Study Materials for {{ seo_data.subject_name }}</h3>
        <p>{{ seo_data.subject_name }} is a key subject in the SPPU curriculum. Our question paper collection helps students understand exam patterns, practice effectively, and improve academic performance.</p>
        <div>
            <h3>Direct Links to Question Papers:</h3>
            {% for pdf in pdf_data_for_js %}
                <a href="{{ pdf.url }}" download="{{ pdf.filename }}">Download {{ pdf.filename }} ({{ seo_data.subject_name }})</a>
            {% endfor %}
        </div>

        <h2>Relevant Keywords & Topics</h2>
        <p>Explore {{ seo_data.subject_name }} resources including SPPU question papers from Savitribai Phule Pune University. Find INSEM and ENDSEM papers for effective examination preparation. Our platform offers academic resources, a PDF viewer for online study, university question papers, and materials for semester examinations.</p>
    </div>

    <header>
        <div class="header-info">
            <button class="back" id="back-btn" aria-label="Go back to question papers list">
                <svg class="icon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Back
            </button>
            <h1><div class="subject-badge" id="subject-display">{{ seo_data.subject_name }}</div></h1>
        </div>
        <div class="header-center">
            <div class="control-group">
                <label for="pdf-count">Layout:</label>
                <select id="pdf-count" aria-label="Select PDF layout">
                    <option value="1" selected>Single</option>
                    <option value="2">Split (2)</option>
                    <option value="3">Split (3)</option>
                    <option value="4">Grid (4)</option>
                </select>
            </div>
            <div class="control-group">
                <label for="exam-type">Exam:</label>
                <select id="exam-type" aria-label="Select exam type">
                    <option value="insem">INSEM</option>
                    <option value="endsem">ENDSEM</option>
                </select>
            </div>
        </div>
        <div class="header-controls">
            <button class="primary" id="fullscreen-btn" aria-label="Toggle fullscreen mode">
                <svg class="icon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                Fullscreen
            </button>
        </div>
    </header>

    <div class="grid-1" id="pdf-container">
        <div class="no-pdf-message">Loading PDFs...<div class="loader"></div></div>
    </div>

<script>
    'use strict';

    const initialPdfDataFromServer = {{ pdf_data_for_js | tojson | safe }};
    const subjectNameFromServer = {{ seo_data.subject_name | tojson | safe }};

    const DOM = {
        pdfContainer: document.getElementById('pdf-container'),
        subjectDisplay: document.getElementById('subject-display'),
        pdfCount: document.getElementById('pdf-count'),
        examType: document.getElementById('exam-type'),
        fullscreenBtn: document.getElementById('fullscreen-btn'),
        backBtn: document.getElementById('back-btn')
    };

    const state = {
        pdfFiles: [],
        isRendering: false,
        activeObjectURLs: new Map(),
        renderQueue: Promise.resolve(),
        pdfViewerBase: '/static/pdfjs/web/viewer.html',
        pdfCache: new Map()
    };

    const debounce = (func, wait) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    };

    function updateSubjectDisplay() {
        DOM.subjectDisplay.textContent = subjectNameFromServer || "Subject";
    }

    const filterPDFs = (() => {
        const cache = new Map();
        const maxSize = 5;
        return (examType) => {
            const key = examType.toLowerCase();
            if (cache.has(key)) {
                 const val = cache.get(key);
                 cache.delete(key);
                 cache.set(key, val);
                 return val;
            }
            const result = state.pdfFiles.filter(file => file.date.toLowerCase().includes(key));
            if (cache.size >= maxSize) cache.delete(cache.keys().next().value);
            cache.set(key, result);
            return result;
        };
    })();

    async function fetchAndCachePDF(pdfUrl) {
        if (state.pdfCache.has(pdfUrl)) return;
        try {
            const response = await fetch(pdfUrl, { cache: 'default' }); // Use browser's default cache behavior
            if (!response.ok) {
                console.error(`Failed to fetch PDF for caching: ${pdfUrl}, Status: ${response.status}`);
                return;
            }
            const blob = await response.blob();
            state.pdfCache.set(pdfUrl, blob);
        } catch (error) {
            console.error(`Error caching PDF ${pdfUrl}:`, error);
        }
    }

    function prefetchAndCachePDFs() {
        if (!state.pdfFiles.length) return;
        if (state.pdfFiles[0]) fetchAndCachePDF(state.pdfFiles[0].link); // Prioritize first PDF
        state.pdfFiles.slice(1).forEach(pdf => setTimeout(() => fetchAndCachePDF(pdf.link), 200)); // Stagger others
    }

    async function loadPdfIntoIframe(iframe, pdfUrl, loader) {
        const oldObjectURL = state.activeObjectURLs.get(iframe);
        if (oldObjectURL) {
            URL.revokeObjectURL(oldObjectURL);
            state.activeObjectURLs.delete(iframe);
        }

        let fileUrlToLoad;
        if (state.pdfCache.has(pdfUrl)) {
            const blob = state.pdfCache.get(pdfUrl);
            fileUrlToLoad = URL.createObjectURL(blob);
            state.activeObjectURLs.set(iframe, fileUrlToLoad);
        } else {
            try {
                const response = await fetch(pdfUrl, { cache: 'default' }); // Use browser's default cache
                if (!response.ok) throw new Error(`HTTP error ${response.status} for ${pdfUrl}`);
                const blob = await response.blob();
                fileUrlToLoad = URL.createObjectURL(blob);
                state.activeObjectURLs.set(iframe, fileUrlToLoad);
                state.pdfCache.set(pdfUrl, blob); // Add to our blob cache
            } catch (error) {
                console.error(`Error fetching PDF ${pdfUrl}:`, error);
                // Fallback to direct URL if blob creation fails; PDF.js viewer might handle it.
                fileUrlToLoad = pdfUrl;
            }
        }

        const iframeSrc = `${state.pdfViewerBase}?file=${encodeURIComponent(fileUrlToLoad)}`;
        iframe.src = iframeSrc;

        iframe.onload = () => {
            if (loader && loader.parentNode) loader.remove();
        };
        iframe.onerror = () => {
            console.error(`Iframe failed to load src: ${iframe.src}`);
            if (loader && loader.parentNode) loader.remove();
            if (iframe.parentElement) {
                iframe.parentElement.innerHTML = '<div class="no-pdf-message">Error loading PDF. Please check the URL and network.</div>';
            }
        };
    }

    async function renderPDFs() {
        if (state.isRendering) return;
        state.isRendering = true;

        await state.renderQueue;
        state.renderQueue = new Promise(async (resolve) => {
            const count = parseInt(DOM.pdfCount.value, 10);
            const examType = DOM.examType.value;
            const filteredData = filterPDFs(examType);

            DOM.pdfContainer.querySelectorAll('iframe').forEach(iframe => {
                const oldObjectURL = state.activeObjectURLs.get(iframe);
                if (oldObjectURL) {
                    URL.revokeObjectURL(oldObjectURL);
                    state.activeObjectURLs.delete(iframe);
                }
            });

            DOM.pdfContainer.className = `grid-${count}`;
            DOM.pdfContainer.innerHTML = filteredData.length ? '' : '<div class="no-pdf-message">No papers for this filter.</div>';

            if (!filteredData.length) {
                state.isRendering = false;
                resolve();
                return;
            }

            const fragment = document.createDocumentFragment();
            const maxRender = Math.min(count, filteredData.length);

            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = 'pdf-viewer';
                if (i < maxRender) {
                    const loader = document.createElement('div');
                    loader.className = 'loader-container';
                    loader.innerHTML = '<div class="loader"></div>';
                    div.appendChild(loader);

                    const selector = createPaperSelector(filteredData, i, `viewer-${i}`);
                    div.appendChild(selector);

                    const iframe = document.createElement('iframe');
                    iframe.title = `PDF Viewer ${i + 1} - ${filteredData[i].originalFilename}`;
                    div.appendChild(iframe);
                    loadPdfIntoIframe(iframe, filteredData[i].link, loader);
                } else {
                    div.innerHTML = '<div class="no-more-papers">No additional paper for this slot.</div>';
                }
                fragment.appendChild(div);
            }
            DOM.pdfContainer.appendChild(fragment);
            state.isRendering = false;
            resolve();
        });
    }

    function createPaperSelector(data, initialIndex, viewerId) {
        const selectorContainer = document.createElement('div');
        selectorContainer.className = 'paper-selector';

        const label = document.createElement('label');
        label.className = 'paper-selector-label';
        label.textContent = 'Paper:';
        const selectId = `paper-select-${viewerId}`;
        label.htmlFor = selectId;

        const select = document.createElement('select');
        select.id = selectId;
        select.setAttribute('aria-label', `Select paper for viewer ${viewerId.split('-')[1] + 1}`);
        select.size = 1;
        select.addEventListener('focus', () => { select.size = Math.min(5, data.length || 1); });
        select.addEventListener('blur', () => { select.size = 1; });
        select.addEventListener('change', () => { select.size = 1; });


        data.forEach((item, idx) => {
            const option = document.createElement('option');
            option.value = idx;
            option.textContent = item.date;
            if (idx === initialIndex) option.selected = true;
            select.appendChild(option);
        });

        select.addEventListener('change', debounce(async (e) => {
            const idx = parseInt(e.target.value, 10);
            const pdfUrl = data[idx].link;
            const viewerDiv = selectorContainer.closest('.pdf-viewer');
            const iframe = viewerDiv.querySelector('iframe');
            if (!iframe) { console.error(`Iframe not found for ${viewerId}`); return; }
            iframe.title = `PDF Viewer ${viewerId.split('-')[1] + 1} - ${data[idx].originalFilename}`;

            const loader = document.createElement('div');
            loader.className = 'loader-container';
            loader.innerHTML = '<div class="loader"></div>';
            viewerDiv.insertBefore(loader, iframe);
            await loadPdfIntoIframe(iframe, pdfUrl, loader);
        }, 150));

        selectorContainer.appendChild(label);
        selectorContainer.appendChild(select);
        return selectorContainer;
    }

    function toggleFullscreen() {
        if (document.fullscreenElement) {
            document.exitFullscreen().catch(err => console.error("Error exiting fullscreen:", err));
        } else {
            document.documentElement.requestFullscreen({ navigationUI: 'hide' }).catch(err => console.error("Error entering fullscreen:", err));
        }
    }

    function updateFullscreenButton() {
        DOM.fullscreenBtn.innerHTML = document.fullscreenElement ?
            `<svg class="icon" viewBox="0 0 24 24"><path d="M4 14h6m0 0v6m0-6l-7 7m17-11h-6m0 0V4m0 6l7-7"/></svg> Exit Fullscreen` :
            `<svg class="icon" viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg> Fullscreen`;
    }

    function setupEventListeners() {
        const debouncedRender = debounce(renderPDFs, 250);
        DOM.pdfCount.addEventListener('change', debouncedRender);
        DOM.examType.addEventListener('change', debouncedRender);
        DOM.fullscreenBtn.addEventListener('click', toggleFullscreen);
        DOM.backBtn.addEventListener('click', () => window.location.href = '/questionpapers'); // Assuming this is the correct back URL
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.fullscreenElement) {
                document.exitFullscreen().catch(err => console.error("Error exiting fullscreen on escape:", err));
            }
        });
    }

    async function init() {
        updateSubjectDisplay();
        setupEventListeners();

        if (initialPdfDataFromServer && initialPdfDataFromServer.length > 0) {
            state.pdfFiles = initialPdfDataFromServer
                .map(pdfObject => {
                    if (!pdfObject || typeof pdfObject.filename !== 'string' || typeof pdfObject.url !== 'string') {
                        console.warn('Skipping invalid PDF object:', pdfObject);
                        return null;
                    }
                    return {
                        date: pdfObject.filename.replace(/\.pdf$/i, ''),
                        link: pdfObject.url,
                        originalFilename: pdfObject.filename
                    };
                })
                .filter(item => item !== null)
                .sort((a, b) => b.date.localeCompare(a.date)); // Newest first

            const hasInsem = state.pdfFiles.some(file => file.date.toLowerCase().includes('insem'));
            const hasEndsem = state.pdfFiles.some(file => file.date.toLowerCase().includes('endsem'));

            DOM.examType.querySelector('option[value="insem"]').disabled = !hasInsem;
            DOM.examType.querySelector('option[value="endsem"]').disabled = !hasEndsem;

            if (hasInsem) DOM.examType.value = 'insem';
            else if (hasEndsem) DOM.examType.value = 'endsem';
            // If neither, it will default to the first available or INSEM if both disabled (which shouldn't happen if list is not empty)

            prefetchAndCachePDFs();

            // Preload PDF.js viewer to warm it up
            const preloadIframe = document.createElement('iframe');
            preloadIframe.style.cssText = 'display:none !important; width:1px; height:1px; opacity:0; pointer-events:none;';
            preloadIframe.setAttribute('aria-hidden', 'true');
            preloadIframe.src = state.pdfViewerBase;
            document.body.appendChild(preloadIframe);
            setTimeout(() => {
                if (preloadIframe.parentNode) preloadIframe.remove();
            }, 5000); // Remove after 5 seconds

            renderPDFs();
        } else {
            DOM.pdfContainer.innerHTML = '<div class="no-pdf-message">No question papers found for this subject.</div>';
            DOM.subjectDisplay.textContent = subjectNameFromServer || 'No Subject';
        }
    }

    document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>